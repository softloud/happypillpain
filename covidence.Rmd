---
title: "Covidence"
description: |
  For checking with Hollie and Gav.
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r pkgs}
library(tidyverse)
library(gt)
library(RColorBrewer)
library(targets)
library(happypillpain)


```

## in this document

- model notes from protocol
- QA for model
- model definition

These all have different objectives, but are overlapping. 

# notation

Network meta-analysis provides a means of aggregating and comparing the results of all studies examining the effect of antidepressants on an outcome of interest.

We now define the parameters of the model for outcome, using White *et al.*'s notation.

Let $i = 1, \dots, n$ denote the study, and $k = 1, \dots, K$ denote the treatment. 

Let $R_i$ be the set of treatments in study $i$, which we call the study design. 

Let $\theta_{ik}^a$ be the parameter of interest in arm $k$ of study $i$ [@white2019].

Now we define our problem of measuring the efficacy of antidepressants in the treatment of adults with chronic pain. 

We have multiple outcomes. Let $j = 1, \dots J$ denote the outcome. 

Let $y_{jik}^a$ denote the $j$th outcome effect for arm $k$ of study $i$. In a network meta-analaysis, we know it's likely $R_i \subsetneqq K$, that is, only some of the $K$ treatments are compared in each study.  

Let $d_{ik}^a$ denote the contrast effect for arm $k$'s relative effect to placebo $k'$ in study $i$.

# model definition

Our current objective is to model the primary outcomes using nma, performing the appropriate diagnostic statistical checks. 

We need to check the inputs and the outputs are correct. 

We can use the data to describe the arms or the contrasts.

## describe the arms

We assume 

$$
\begin{cases}
y_{jik}^a \sim N(\Theta_{jki}, \Sigma_{ji})\\
\theta_{jki} \sim N(0, \tau^2)
\end{cases}
$$
so, the model describes the measurements of each arm in a study's effect for an outcome of interest. 

The estimation happens on arm level, which is more precise than contrast level, but there are computational costs associated with arm-based, where contrast-based might be a solution. The output, then, is,

$$
d_{ijk} := d(y_{jik}, y_{jik'}, \sigma_{ji}^2)
$$

where $d$ is an appropriate measure of comparison, such as the $g$ adjustment for standardised mean difference, between treatment $k$ and overall comparator, such as placebo, $k'$. 

And, for a contrast-based output, we would have an estimate of $d$, not the components of $d$,

$$
\begin{cases}
y^c_{jikk'} \sim N(\delta_{jijk'}, \sigma_{ji}^2)\\
\delta_{jik} \sim N(0, \tau^2)
\end{cases}
$$

- [ ] ensure that checks are in place

## in words

So, we assume the observed measure $y^c_{jik}$, of pain affect, $j$, (ask Hollie about affect vs effect in this context), is a comparison between the $i$th study's $k'$ treatment. 

For the pairwise meta-analyses, $k'$ is fixed to placebo, however, in the nma, $k'$ can be any of the set of $k = 1, \dots, K$ treatments. 

We assume this comparison may be thought of in terms of a the $k$th treatment's effect as compared to $k'$, $\delta_{ijk'}$,
$$
y^c_{jikk'} := \delta_{jk'} + \delta_{ji} + \varepsilon_{jikk'} 
$$
- how do white et al. do the notation for nma? k vs k'?

where 
$$
\delta_{jikk'} = \delta_{jkk'} + \delta_{ji}
$$
denotes the comparison of the $j$th outcome between treatments $k$ and $k'$ in the $i$th study, where $\delta_{ji}$ denotes the $i$th study...

## contrast vs arm-based

## design matrices

### what should it be?

$$
\begin{array}
\[y^a_{j11}, y^a_{j12,}\]
\end{array}
$$

### what do we have?


```{r load targets data}
withr::with_dir(here::here(), {
  tar_load(models)
})


```

```{r}
# what went into the model
models %>% 
  pluck(1, "network", "agd_arm") %>% 
  select(starts_with(".")) %>% 
# tag when there are two placebos per study
  group_by(.study, .trt) %>% 
  mutate(
    n_study_int = 1:n()
  )



```




# QA for model

## study

Covidence produces a `Study Identifier` variable, however, this does not uniquely identify the study.

```{r}
hpp_dat <- 
  happypillpain::raw_hpp_dat_path() %>% 
  read_csv(
    col_types =  cols(.default = "c")
  ) 


```

Hollie recorded the titles of the study in the spare `comments` field in the raw data,changed to `study_title` for the analysis.

```{r}
study_id_duplicates <- 

hpp_dat %>% 
  rename(
    study = `Study Identifier`,
    title = Comments
  ) %>% 
  group_by(study) %>% 
  summarise(
    titles = n_distinct(title)
  ) %>% 
  filter(titles > 1) %>% 
  left_join(
    hpp_dat %>% select(study = `Study Identifier`, title = Comments), 
    by = "study"
  ) %>% 
  distinct() 

study_id_duplicates %>% 
  gt()

```

Studies are tagged with a short identifier:

```{r}
dup_studies <- study_id_duplicates %>% 
  pull(study) %>% unique() %>% 
  paste0(collapse = "|")

hpp_dat %>% 
  preliminary_scrub() %>%
  select(study_identifier, study_title) %>%  
  right_join(study_id_duplicates, by = c("study_title" = "title")) %>% 
  distinct()

```


```{r}
# ugh fix this
hpp_dat <- hpp_dat %>% preliminary_scrub()

```


> probably should do over with input data

## arm

Each row of the dataframe is considered to be one arm in one study.

```{r echo=TRUE}
# study_idenfiter + intervention combinations with more than one row
# (should be 0)
hpp_dat %>% 
  count(study_identifier, intervention) %>% 
  filter(n > 1)


```

## intervention

This is more tricky, would be good to get input from others. 

The intervention is encoded with what I would consider to be two distinct variables: dose and drug. 

So far, Charles has extracted the drug, but not the dosage. 

Here is the full list of interventions.

Should any of these be collapsed together, in terms of the model?

```{r}
# possibly organise these 

hpp_dat %>% 
  count(intervention_type, intervention_drug) %>% 
  arrange(desc(n)) %>%
  gt()


```


# protocol notes



## background

We want to assess the comparative efficacy of antidepressants for adults with chronic pain. 

### condition

- **chronic pain** := > 3 months
- **primary pain** := chronic pain as disease, e.g. lower back pain
- **secondary pian** := pain with a specific cause, e.g., osteoarthritis
- assessed by self report
- affects 1/5 of adults in the world
- affects qol, mood, sleep, physical function

### intervention

- different classes of treatment for chemical structure and mechanism of action
- **common classes: TCA, SSRI, SNRI, MAOI** 
- antidepressants are sometimes used 'off-license' to treat chronic pain
- adverse events (e.g., headaches, weight loss) are associated with antidepressants

### how

- antidepressants work by targeting neurotransmitters & receptors associated with mood & emotion
- prevent signal of pain from being absorbed
- perceived pain is reduced

## important

- no nma yet in pain + antidepressants
- contradictory evidence
- no comparison of pain vs mood

## objectives

- assess improvements in pain, mood, pgic, physical function, sleep, and qol by type, class, dose
- adverse events by type, class, dose
- rank efficacy in treating pain, negative affect, and adverse events

### response variable

$y_{jikk'}$ is the response measure for the $j$th outcome's $k$th treatment compared with treatment $k'$ from $R_i$ treatments in the $i$th study.

### moderators and/or subgroup analyses

- class of drug: e.g., TCA, SSRI, SNRI, MAOI: 
- chronic condition: e.g. fibro, osteo 
- primary or secondary
- dosage


