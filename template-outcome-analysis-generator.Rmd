---
title: "analysis"
description: |
  Efficacy of antidepressants for adults with chronic pain
date: "last updated `r Sys.Date()`"
output: 
  distill::distill_article: 
    toc: true
params:
  outcome: pain
  # model: smd
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r pkgs}
# pkgs
library(tidyverse)
library(multinma)
library(nmathresh)
library(glue)
library(targets)
library(gt)
library(metafor)
conflicted::conflict_prefer("filter", "dplyr")

```

```{r get data}
withr::with_dir(here::here(), {
  tar_load(models)
  tar_load(outcomes_of_interest)
})

hpp_nma <-
  models %>% 
  keep(~.$outcome == params$outcome) %>% 
  pluck(1)


# all this plucking and whatnot stripped it of the class value
class(hpp_nma) <- "stan_nma"

```

```{r generating outcomes, eval=FALSE}
# this is for creating the markdown files
models %>% 
  map_chr("outcome") %>% 
  map(
  .f = function(outcome) {
      file_name_outcome <- str_replace_all(outcome, " ", "-")  
    rmarkdown::render(
      input = "template-outcome-analysis-generator.Rmd",
      output_file = glue("docs/outcome-analysis-{file_name_outcome}.html"),
      params = list(
        outcome = outcome 
      )
    )
  }
  
  )


```

## network and model

Network meta-analysis provides a means of aggregating and comparing the results of all studies examining the effect of antidepressants on `r params$outcome`.

We now define the parameters of the model for the `r params$outcome` outcome, using White *et al.*'s notation.

Let $i = 1, \dots, n$ denote the study, and $k = 1, \dots, K$ denote the treatment. 

Let $R_i$ be the set of treatments in study $i$, which we call the study design. 

Let $\theta_{ik}^a$ be the parameter of interest in arm $k$ of study $i$ [@white2019].

Let $y_{ik}^a$ denote the observed effect for arm $k$ of study $i$. 



### arm-based likelihood

Arm-based likelihood is 

```{r network, fig.height=5, fig.width=10}

plot(hpp_nma$network)

```

### contrast-based likelihood

## model results

```{r network plot}
plot(hpp_nma)

```

```{r model results}
plot_prior_posterior(hpp_nma)

```

## pairwise analyses

Individual analyses for each treatment, compared with placebo.

-   [ ] adapt notation to our problem

### why do pairwise

### pairwise meta-analysis

We want to fit a pairwise meta-analysis for each treatment, with concise summaries, as well as in-depth supplementary material. We split the analysis into two components, as the number of interventions per outcome is considerable, see below Table, in some cases, according to recommendations in Section 11.6.4 of the Handbook [@higgins2019cochrane].

```{r }

# get number of outcomes




# how many outcomes we have
n_outcomes <-
  outcomes_of_interest %>%
  length()

# how many studies per outcome
studies_per_treatment <- 
models %>%
  map("network") %>%
  map("agd_arm") %>%
  map_df(
    .f = function(df) {
      df %>% 
      summarise(n_studies = n_distinct(.study),
                n_interventions = n_distinct(.trt)) %>% 
        mutate(
          outcome = df %>% pull(outcome) %>% unique()
        )
    }
  ) %>% 
  select(outcome, everything())


```

```{r outcomesperstudy, caption = "Number of studies and number of interventions, including placebo, per outcome."}
studies_per_treatment %>% 
  gt() %>% 
  cols_label(
    outcome = "Outcome",
    n_studies = "Number of studies",
    n_interventions = "Number of interventions"
  )  %>% 
  tab_header(
    title = "Number of studies and interventions, by outcome",
    subtitle = "Interventions include placebo, as sometimes there are more than one type of placebo"
  )


```

### pairwise model

To avoid confusion, we need to state the pairwise models being fun using the same notation as we use for the network meta-analysis models. 

Here we consider a subset of data for $j$, that is for only one outcome, $j'$, so that we expect the same as above except we fix the index, so that $y^a_{j = j'|ki}$. 

$$
d_i \sim N(\delta_i, \sigma^2)\\
\delta_{i} \sim N(\delta, \tau^2)
$$
Given the data, what description of the data is most plausible, if we define the components of the data as follows? We assume a random-effects structure, which is to say, we can approximate, with a measurable degree of plausibility, the expected value of a standardised mean difference $d_i$ of an outcome $j'$ of interest for a study $i$ and antidepressant treatment $k$, as compared with placebo. We assume there is variability introduced by the study design $\tau^2$, as well as sampling error $\sigma^2$.  

```{r eval=FALSE}

# it would be cool to visualise it 

sigma <- 0.3
tau <- 0.1

distn_plot <- 
  tibble(
  x = seq(-1, 1, by = 0.001),
  d = dnorm(x, mean = 0, sd = sigma),
  delta = dnorm(x, mean = 0, sd = tau)
) %>% 
  pivot_longer(
    cols = c(d, delta),
    names_to = "parameter",
    values_to = "y"
  ) %>% 
  ggplot(
    aes(x = x, y = y)
  ) + 
  geom_line(alpha = 0.4) +
  facet_grid(parameter ~ ., scales = "free", labeller = label_parsed) + 
  ggthemes::theme_tufte() +
    theme(
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      axis.text.y = element_blank(),
      strip.text.y = element_text(angle = 0)
    ) 


```

```{r}



tibble(
  x = c(-1, 1)
) %>% 
  ggplot(aes(x)) + 
  stat_function(fun = dnorm,
                colour = "darkblue",
                args = list(mean = 0, sd = 0.5),
                alpha = 0.2) +
  stat_function(fun = dnorm,
                fill = "darkblue",
                args = list(mean = 0, sd = 0.5),
                xlim = c(-0.5, 0.5),
                geom = "area",
                alpha = 0.2
                ) +
  stat_function(fun = dnorm,
                colour = "darkgreen",
                alpha = 0.2,
                args = list(mean = 0.1, sd = 0.2)) +
  stat_function(fun = dnorm,
                fill = "darkgreen",
                alpha = 0.2,
                args = list(mean = 0.1, sd = 0.2),
                xlim = c(-0.2 + 0.1, 0.2 + 0.1),
                geom = "area") +
  theme_minimal() +
  ylim(-1, 2)

```



## input: design matrix 

```{r}


hpp_nma # %>% 
  # pluck("network", "agd_arm") %>% 

```

## output

```{r}
hpp_nma 
  
```


### structuring nma data for metafor


```{r eval=FALSE}


long_obs <-

no_dosage %>%
  # filter by treatment, in addition to outcome
  filter(
    .trt == "duloxetine" | .trt == "placebo"
  ) %>% 
  # all of this is dealing with duplicate placebos
  
  # tag counts
  group_by(.study) %>% 
  mutate(
    placebo_duplicate = sum(.trt == "placebo") > 1
  ) %>% 
  # filter out studies that only have placebos
  filter(sum(.trt != "placebo") != 0) %>% 
  group_by(.study, .trt) %>% 
  mutate(
    trt_n = 1:n() 
  ) %>% 
  mutate(
    .study = if_else(
      placebo_duplicate,
      str_c(.study, as.character(trt_n), sep = " | "),
      as.character(.study)
    )
  ) %>% 
  rename(
    study = .study,
    trt = .trt,
    effect = .y,
    effect_se = .se,
    effect_n = .sample_size
  ) %>% 
  select(-placebo_duplicate, -trt_n) %>% 
  ungroup() 


# placebo
placebo_obs <- 
long_obs %>% 
  filter(str_detect(trt, "placebo")) %>% 
  rename(
    placebo_effect = effect,
    placebo_se = effect_se,
    placebo_n = effect_n
  ) %>% 
  select(-trt)

trt_obs <-
 long_obs %>% 
  filter(!str_detect(trt, "placebo")) %>% 
  rename(
    trt_effect = effect,
    trt_se = effect_se,
    trt_n = effect_n
  ) %>% 
  select(-trt)

wide_pairwise <- 
left_join(trt_obs, placebo_obs, by = c("study"))


```

```{r eval=FALSE}
wide_pairwise %>% 
  mutate(
    trt_sd = sqrt(trt_n) * trt_se,
    placebo_sd = sqrt(placebo_n) * placebo_se
  ) %>% 
  escalc(
    measure = "SMD",
    data = .,
    m1i = placebo_effect,
    m2i = trt_effect,
    sd1i = placebo_sd,
    sd2i = trt_sd,
    n1i = placebo_n,
    n2i = trt_n
  ) %>% 
  rma(
    data = .,
    yi = yi,
    vi = vi, 
    slab = study
  ) %>% forest()

```


### concise summary

### long-form supplementary
